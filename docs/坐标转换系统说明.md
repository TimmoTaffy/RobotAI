# 坐标转换系统说明文档

## 1. 坐标系定义

### 1.1 世界坐标系 (world)
- 原点：场地原点
- x 轴：指向东
- y 轴：指向北
- z 轴：指向上

### 1.2 车体坐标系 (vehicle)
- 原点：车体几何中心
- x 轴：指向车头
- y 轴：指向车体左侧
- z 轴：指向上方

### 1.3 云台坐标系 (turret)
- 原点：云台旋转中心
- x 轴：指向枪管方向
- y 轴：指向左侧
- z 轴：指向上方

### 1.4 激光雷达坐标系 (lidar)
- 原点：激光雷达扫描中心
- x 轴：指向前方
- y 轴：指向左侧
- z 轴：指向上方

### 1.5 相机坐标系 (camera)
- 原点：相机光学中心
- x 轴：指向右方
- y 轴：指向下方
- z 轴：指向前方（光轴方向）

### 1.6 IMU坐标系 (imu)
- 原点：IMU 传感器中心
- x 轴：指向前方
- y 轴：指向左侧
- z 轴：指向上方

## 2. 模块依赖关系

### 2.1 Localization 到 Transforms 的依赖

1. **云台姿态相关**
   - `localization/turret_pose.py` → `transforms/turret_to_vehicle.py`
   - 依赖内容：云台姿态估计结果 [roll, pitch, yaw]
   - 用途：将云台观测到的目标转换到车体坐标系
   - 数据流：IMU数据 → 姿态解算 → 坐标转换

2. **车体定位相关**
   - `localization/ekf_fusion.py` → `transforms/vehicle_to_world.py`
   - 依赖内容：车体位姿估计结果 [x, y, theta]
   - 用途：将车体坐标系下的所有信息转换到世界坐标系
   - 数据融合：IMU + 轮速计 + 磁力计 → EKF → 位姿估计

3. **里程计相关**
   - `localization/dead_reckoning.py` → `transforms/vehicle_to_world.py`
   - 依赖内容：里程计位姿估计 [x, y, theta]
   - 用途：作为 EKF 的补充定位方案
   - 备份机制：当 EKF 不可用时切换到里程计

4. **激光雷达相关**
   - `localization/lidar_matcher.py` → `transforms/lidar_to_vehicle.py`
   - 依赖内容：激光雷达位姿估计 [x, y, z, roll, pitch, yaw]
   - 用途：点云配准和位姿微调
   - 实现：ICP 匹配或 NDT 配准

5. **相机位姿相关**
   - `localization/camera_pose.py` → `transforms/camera_to_vehicle.py`
   - 依赖内容：相机外参估计 [R|t]
   - 用途：视觉信息坐标转换
   - 标定：相机到车体的外参标定

### 2.2 数据流向图
```
传感器数据 ───> [Localization] ───> 位姿估计 ───> [Transforms] ───> 坐标转换
                    │                                  │
                    └──────────────> 时间同步 <─────────┘
```

### 2.3 开发注意事项
1. **先后顺序**：
   - 必须先有 Localization 的位姿估计结果
   - 才能进行 Transforms 的坐标转换

2. **时间同步**：
   - Localization 输出的位姿必须带时间戳
   - Transforms 使用时间最接近的位姿数据

3. **异常处理**：
   - Transforms 必须对无效的位姿数据有合理的处理策略

### 2.4 坐标转换链
```
                  ┌─────────────┐
                  │   世界坐标系  │
                  └──────┬──────┘
                         │
                  ┌──────┴──────┐
                  │   车体坐标系  │
                  └──┬───┬───┬──┘
               ┌─────┘   │   └────┐
               │         │        │
        ┌──────┴───┐     │    ┌───┴──────┐
        │ IMU坐标系 │     │    │ 相机坐标系 │
        └──────────┘     │    └──────────┘
                         │
                   ┌─────┴─────┐
                   │  云台坐标系 │
                   └───────────┘
```

### 2.5 时序关系
```
传感器数据采集 ──> 传感器数据解析 ──> 位姿估计 ──> 坐标转换 ──> 世界模型更新
     ^                                                        │
     └────────────────── 反馈闭环 ◄────────────────────────────┘
```

## 3. Localization 提供给 Transforms 的接口

### 3.1 云台位姿接口
```python
class TurretPose:
    def get_turret_state(self) -> TurretState:
        """
        获取用于坐标转换的云台状态
        返回：TurretState 对象，包含：
        - orientation: [roll, pitch, yaw]，单位：弧度
        - timestamp: UNIX 时间戳

        说明：transforms/turret_to_vehicle.py 依赖此接口获取云台姿态
        """

    def get_latest_state(self) -> Optional[TurretState]:
        """
        获取最新的云台状态
        如果无法获得状态，返回 None
        用途：在实时性要求不高的场景下使用
        """
```

### 3.2 车体位姿接口
```python
class VehicleLocalization:
    def get_vehicle_state(self) -> VehicleState:
        """
        获取用于坐标转换的车体状态
        返回：VehicleState 对象，包含：
        - position: [x, y]，单位：米
        - theta: 朝向角，单位：弧度
        - velocity: [vx, vy]，单位：米/秒
        - timestamp: UNIX 时间戳

        说明：transforms/vehicle_to_world.py 依赖此接口
        """

    def get_state_at_time(self, timestamp: float) -> Optional[VehicleState]:
        """
        获取指定时刻的车体状态
        参数：timestamp - 目标时间戳
        返回：该时刻的车体状态，无法获得则返回 None
        用途：实现不同传感器数据的时间同步
        """

    def get_backup_state(self) -> Optional[VehicleState]:
        """
        获取备用定位结果（如纯里程计）
        用途：当主定位系统不可用时的备选方案
        """
```

### 3.3 激光雷达位姿接口
```python
class LidarPose:
    def get_lidar_pose(self) -> LidarPose:
        """
        获取激光雷达相对车体的位姿
        返回：LidarPose 对象，包含：
        - position: [x, y, z]，单位：米
        - orientation: [roll, pitch, yaw]，单位：弧度
        
        说明：主要用于点云坐标转换和扫描匹配
        """
```

### 3.4 相机位姿接口
```python
class CameraPose:
    def get_camera_pose(self) -> CameraPose:
        """
        获取相机相对车体的位姿
        返回：CameraPose 对象，包含：
        - position: [x, y, z]，单位：米
        - orientation: [roll, pitch, yaw]，单位：弧度
        - intrinsics: 相机内参矩阵
        - distortion: 畸变参数
        
        说明：用于视觉信息的坐标转换和投影
        """
```